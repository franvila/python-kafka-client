name: Create Tag and Release
on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Ref (tag) to build'
        required: true
        default: '0.1.0'
jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ vars.REGISTRY_SERVER != '' && vars.REGISTRY_USERNAME != '' }}
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v5

      - name: 'Check team membership'
        if: ${{ github.repository == 'kroxylicious/kroxylicious' }}
        uses: tspascoal/get-user-teams-membership@v3
        id: team-membership
        with:
          username: ${{ github.actor }}
          team: Developers
          GITHUB_TOKEN: ${{ secrets.KROXYLICIOUS_RELEASE_TOKEN }}

      - name: 'Stop workflow if user is not a Developer'
        if: ${{ github.repository == 'kroxylicious/kroxylicious' && steps.team-membership.outputs.isTeamMember == 'false' }}
        run: |
          echo "${{ github.actor }} is not a member of https://github.com/orgs/kroxylicious/teams/Developers)"
          exit -1

      - name: 'Configure Git username/email'
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR_ID}+${GITHUB_ACTOR}@users.noreply.github.com"    

      - name: Create Tag
        run: |
            git tag -a "${{ github.event.inputs.ref }}" -m "Release ${{ github.event.inputs.ref }}"
            git push origin "${{ github.event.inputs.ref }}"
#      - name: Create Release
#        uses: actions/create-release@v1
#        env:
#          GITHUB_TOKEN: ${{ secrets.KROXYLICIOUS_RELEASE_TOKEN }}
#        with:
#          tag_name: '${{ github.event.inputs.ref }}'
#          release_name: 'Release ${{ github.event.inputs.ref }}'
#          draft: false
#          prerelease: false
